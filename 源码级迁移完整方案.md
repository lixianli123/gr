# ğŸ”§ HSTU + Dynamic Embeddings æºç çº§è¿ç§»å®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•
1. [æºç æ–‡ä»¶æ¸…å•](#æºç æ–‡ä»¶æ¸…å•)
2. [æ–°æ–‡ä»¶å¤¹ç»“æ„](#æ–°æ–‡ä»¶å¤¹ç»“æ„)
3. [æ–‡ä»¶æ”¾ç½®è¯¦ç»†æ­¥éª¤](#æ–‡ä»¶æ”¾ç½®è¯¦ç»†æ­¥éª¤)
4. [ç¼–è¯‘é…ç½®](#ç¼–è¯‘é…ç½®)
5. [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
6. [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)

---

## æºç æ–‡ä»¶æ¸…å•

### ç¬¬1æ­¥: ç¡®å®šéœ€è¦æ‹¿èµ°çš„æ–‡ä»¶

#### A. HSTU Attentionæ ¸å¿ƒæ–‡ä»¶ (å¿…éœ€)

```bash
# ä½ç½®: corelib/hstu/

ã€CUTLASS CUDAæºç ã€‘- çº¦50ä¸ªæ–‡ä»¶
â”œâ”€â”€ csrc/hstu_attn/
â”‚   â”œâ”€â”€ hstu_api.cpp                    # C++ APIæ¥å£
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ hstu_fwd.h                  # å‰å‘ä¼ æ’­æ¨¡æ¿
â”‚       â”œâ”€â”€ hstu_bwd.h                  # åå‘ä¼ æ’­æ¨¡æ¿
â”‚       â”œâ”€â”€ hstu.h                      # ä¸»å¤´æ–‡ä»¶
â”‚       â”œâ”€â”€ kernel_traits.h             # Kernelç‰¹æ€§å®šä¹‰
â”‚       â”œâ”€â”€ block_info.h                # Blockä¿¡æ¯
â”‚       â”œâ”€â”€ static_switch.h             # ç¼–è¯‘æ—¶åˆ†æ”¯
â”‚       â””â”€â”€ utils.h                     # å·¥å…·å‡½æ•°

ã€Pythonæ¥å£ã€‘- 2ä¸ªæ–‡ä»¶
â”œâ”€â”€ hstu_attn/
â”‚   â”œâ”€â”€ __init__.py                     # æ¨¡å—åˆå§‹åŒ–
â”‚   â””â”€â”€ hstu_attn_interface.py          # Pythonæ¥å£

ã€ç¼–è¯‘é…ç½®ã€‘- 3ä¸ªæ–‡ä»¶
â”œâ”€â”€ setup.py                            # setuptoolsé…ç½®
â”œâ”€â”€ CMakeLists.txt                      # CMakeé…ç½® (å¯é€‰)
â””â”€â”€ Makefile                            # Makeé…ç½® (å¯é€‰)
```

#### B. Dynamic Embeddingsæ ¸å¿ƒæ–‡ä»¶ (å¿…éœ€)

```bash
# ä½ç½®: corelib/dynamicemb/

ã€CUDAæºç ã€‘- çº¦40ä¸ªæ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ dynamic_emb_op.cu               # ä¸»æ“ä½œ
â”‚   â”œâ”€â”€ dynamic_variable_base.cu        # å˜é‡åŸºç±»
â”‚   â”œâ”€â”€ dynamic_variable_base.h         # å˜é‡åŸºç±»å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ hkv_variable.h                  # HKVå˜é‡
â”‚   â”œâ”€â”€ hkv_variable.cuh                # HKVå˜é‡CUDA
â”‚   â”œâ”€â”€ lookup_forward.cu               # Lookupå‰å‘
â”‚   â”œâ”€â”€ lookup_forward.h                # Lookupå‰å‘å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ lookup_backward.cu              # Lookupåå‘
â”‚   â”œâ”€â”€ lookup_backward.h               # Lookupåå‘å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ lookup_kernel.cuh               # Lookup kernel
â”‚   â”œâ”€â”€ optimizer.cu                    # ä¼˜åŒ–å™¨
â”‚   â”œâ”€â”€ optimizer.h                     # ä¼˜åŒ–å™¨å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ optimizer_kernel.cuh            # ä¼˜åŒ–å™¨kernel
â”‚   â”œâ”€â”€ initializer.cu                  # åˆå§‹åŒ–å™¨
â”‚   â”œâ”€â”€ initializer.cuh                 # åˆå§‹åŒ–å™¨CUDA
â”‚   â”œâ”€â”€ unique_op.cu                    # Uniqueæ“ä½œ
â”‚   â”œâ”€â”€ unique_op.h                     # Uniqueæ“ä½œå¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ unique_variable.cu              # Uniqueå˜é‡
â”‚   â”œâ”€â”€ unique_variable.h               # Uniqueå˜é‡å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ index_calculation.cu            # ç´¢å¼•è®¡ç®—
â”‚   â”œâ”€â”€ index_calculation.h             # ç´¢å¼•è®¡ç®—å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ sparse_block_bucketize_features.cu  # ç‰¹å¾åˆ†æ¡¶
â”‚   â”œâ”€â”€ sparse_block_bucketize_features_utils.h  # åˆ†æ¡¶å·¥å…·
â”‚   â”œâ”€â”€ torch_utils.cu                  # PyTorchå·¥å…·
â”‚   â”œâ”€â”€ torch_utils.h                   # PyTorchå·¥å…·å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ utils.cpp                       # C++å·¥å…·
â”‚   â”œâ”€â”€ utils.h                         # å·¥å…·å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ check.h                         # æ£€æŸ¥å®
â”‚   â”œâ”€â”€ module_bind.cu                  # æ¨¡å—ç»‘å®š
â”‚   â””â”€â”€ hkv_variable_instantiations/    # HKVå®ä¾‹åŒ– (18ä¸ª.cuæ–‡ä»¶)
â”‚       â”œâ”€â”€ HKVVariable__int64_t___half_EvictStrategy__kLru.cu
â”‚       â”œâ”€â”€ HKVVariable__int64_t___half_EvictStrategy__kLfu.cu
â”‚       â”œâ”€â”€ HKVVariable__int64_t___half_EvictStrategy__kCustomized.cu
â”‚       â”œâ”€â”€ HKVVariable__int64_t___nv_bfloat16_EvictStrategy__kLru.cu
â”‚       â”œâ”€â”€ HKVVariable__int64_t___nv_bfloat16_EvictStrategy__kLfu.cu
â”‚       â”œâ”€â”€ HKVVariable__int64_t___nv_bfloat16_EvictStrategy__kCustomized.cu
â”‚       â”œâ”€â”€ HKVVariable__int64_t_float_EvictStrategy__kLru.cu
â”‚       â”œâ”€â”€ HKVVariable__int64_t_float_EvictStrategy__kLfu.cu
â”‚       â”œâ”€â”€ HKVVariable__int64_t_float_EvictStrategy__kCustomized.cu
â”‚       â”œâ”€â”€ HKVVariable__uint64_t___half_EvictStrategy__kLru.cu
â”‚       â”œâ”€â”€ HKVVariable__uint64_t___half_EvictStrategy__kLfu.cu
â”‚       â”œâ”€â”€ HKVVariable__uint64_t___half_EvictStrategy__kCustomized.cu
â”‚       â”œâ”€â”€ HKVVariable__uint64_t___nv_bfloat16_EvictStrategy__kLru.cu
â”‚       â”œâ”€â”€ HKVVariable__uint64_t___nv_bfloat16_EvictStrategy__kLfu.cu
â”‚       â”œâ”€â”€ HKVVariable__uint64_t___nv_bfloat16_EvictStrategy__kCustomized.cu
â”‚       â”œâ”€â”€ HKVVariable__uint64_t_float_EvictStrategy__kLru.cu
â”‚       â”œâ”€â”€ HKVVariable__uint64_t_float_EvictStrategy__kLfu.cu
â”‚       â””â”€â”€ HKVVariable__uint64_t_float_EvictStrategy__kCustomized.cu

ã€Pythonæ¥å£ã€‘- 15ä¸ªæ–‡ä»¶
â”œâ”€â”€ dynamicemb/
â”‚   â”œâ”€â”€ __init__.py                     # æ¨¡å—åˆå§‹åŒ–
â”‚   â”œâ”€â”€ batched_dynamicemb_tables.py    # æ‰¹é‡è¡¨
â”‚   â”œâ”€â”€ batched_dynamicemb_function.py  # æ‰¹é‡å‡½æ•°
â”‚   â”œâ”€â”€ batched_dynamicemb_compute_kernel.py  # è®¡ç®—kernel
â”‚   â”œâ”€â”€ dynamicemb_config.py            # é…ç½®
â”‚   â”œâ”€â”€ key_value_table.py              # KVè¡¨
â”‚   â”œâ”€â”€ optimizer.py                    # ä¼˜åŒ–å™¨æ¥å£
â”‚   â”œâ”€â”€ initializer.py                  # åˆå§‹åŒ–å™¨æ¥å£
â”‚   â”œâ”€â”€ unique_op.py                    # Uniqueæ“ä½œæ¥å£
â”‚   â”œâ”€â”€ types.py                        # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ utils.py                        # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ input_dist.py                   # è¾“å…¥åˆ†å¸ƒ
â”‚   â”œâ”€â”€ get_planner.py                  # è·å–planner
â”‚   â”œâ”€â”€ construct_twin_module.py        # æ„å»ºtwinæ¨¡å—
â”‚   â”œâ”€â”€ dump_load.py                    # åºåˆ—åŒ–
â”‚   â”œâ”€â”€ incremental_dump.py             # å¢é‡åºåˆ—åŒ–
â”‚   â”œâ”€â”€ planner/                        # è§„åˆ’å™¨ (3ä¸ªæ–‡ä»¶)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ planner.py
â”‚   â”‚   â”œâ”€â”€ enumerators.py
â”‚   â”‚   â””â”€â”€ rw_sharding.py
â”‚   â””â”€â”€ shard/                          # åˆ†ç‰‡ (3ä¸ªæ–‡ä»¶)
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ embedding.py
â”‚       â””â”€â”€ embeddingbag.py

ã€ç¼–è¯‘é…ç½®ã€‘- 2ä¸ªæ–‡ä»¶
â”œâ”€â”€ setup.py                            # setuptoolsé…ç½®
â””â”€â”€ version.txt                         # ç‰ˆæœ¬å·
```

#### C. ä¾èµ–çš„å¤´æ–‡ä»¶åº“ (å¿…éœ€ï¼Œä½†é€šè¿‡gitå­æ¨¡å—)

```bash
# ä½ç½®: third_party/

third_party/
â”œâ”€â”€ cutlass/                            # NVIDIA CUTLASSåº“
â”‚   â””â”€â”€ include/                        # åªéœ€è¦å¤´æ–‡ä»¶
â”‚       â””â”€â”€ cutlass/
â”‚           â””â”€â”€ ... (å¤§é‡å¤´æ–‡ä»¶)
â”‚
â””â”€â”€ HierarchicalKV/                     # NVIDIA HierarchicalKVåº“
    â””â”€â”€ include/                        # åªéœ€è¦å¤´æ–‡ä»¶
        â””â”€â”€ ... (HKVå¤´æ–‡ä»¶)
```

---

## æ–°æ–‡ä»¶å¤¹ç»“æ„

### ç¬¬2æ­¥: åˆ›å»ºç‹¬ç«‹é¡¹ç›®ç»“æ„

```bash
accelerated_modules/                    # æ–°é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ README.md                           # è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ setup.py                            # ä¸»å®‰è£…è„šæœ¬
â”œâ”€â”€ requirements.txt                    # Pythonä¾èµ–
â”œâ”€â”€ build.sh                            # ç¼–è¯‘è„šæœ¬
â”‚
â”œâ”€â”€ third_party/                        # ç¬¬ä¸‰æ–¹ä¾èµ–
â”‚   â”œâ”€â”€ cutlass/                        # CUTLASS (git submodule)
â”‚   â””â”€â”€ HierarchicalKV/                 # HKV (git submodule)
â”‚
â”œâ”€â”€ hstu_attn/                          # HSTU Attentionæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ interface.py                    # Pythonæ¥å£ (é‡å‘½å)
â”‚   â”œâ”€â”€ csrc/                           # C++/CUDAæºç 
â”‚   â”‚   â”œâ”€â”€ hstu_api.cpp
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ hstu_fwd.h
â”‚   â”‚       â”œâ”€â”€ hstu_bwd.h
â”‚   â”‚       â”œâ”€â”€ hstu.h
â”‚   â”‚       â”œâ”€â”€ kernel_traits.h
â”‚   â”‚       â”œâ”€â”€ block_info.h
â”‚   â”‚       â”œâ”€â”€ static_switch.h
â”‚   â”‚       â””â”€â”€ utils.h
â”‚   â””â”€â”€ setup.py                        # HSTUç¼–è¯‘é…ç½®
â”‚
â”œâ”€â”€ dynamicemb/                         # Dynamic Embeddingsæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ src/                            # CUDAæºç 
â”‚   â”‚   â”œâ”€â”€ dynamic_emb_op.cu
â”‚   â”‚   â”œâ”€â”€ dynamic_variable_base.cu
â”‚   â”‚   â”œâ”€â”€ dynamic_variable_base.h
â”‚   â”‚   â”œâ”€â”€ lookup_forward.cu
â”‚   â”‚   â”œâ”€â”€ lookup_forward.h
â”‚   â”‚   â”œâ”€â”€ lookup_backward.cu
â”‚   â”‚   â”œâ”€â”€ lookup_backward.h
â”‚   â”‚   â”œâ”€â”€ optimizer.cu
â”‚   â”‚   â”œâ”€â”€ optimizer.h
â”‚   â”‚   â”œâ”€â”€ initializer.cu
â”‚   â”‚   â”œâ”€â”€ unique_op.cu
â”‚   â”‚   â”œâ”€â”€ ... (å…¶ä»–æ–‡ä»¶)
â”‚   â”‚   â””â”€â”€ hkv_variable_instantiations/
â”‚   â”‚       â””â”€â”€ ... (18ä¸ªå®ä¾‹åŒ–æ–‡ä»¶)
â”‚   â”œâ”€â”€ python/                         # Pythonæ¥å£
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ batched_dynamicemb_tables.py
â”‚   â”‚   â”œâ”€â”€ dynamicemb_config.py
â”‚   â”‚   â”œâ”€â”€ optimizer.py
â”‚   â”‚   â”œâ”€â”€ ... (å…¶ä»–Pythonæ–‡ä»¶)
â”‚   â”‚   â”œâ”€â”€ planner/
â”‚   â”‚   â””â”€â”€ shard/
â”‚   â””â”€â”€ setup.py                        # DynamicEmbç¼–è¯‘é…ç½®
â”‚
â”œâ”€â”€ tests/                              # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ test_hstu_attention.py
â”‚   â””â”€â”€ test_dynamicemb.py
â”‚
â””â”€â”€ examples/                           # ä½¿ç”¨ç¤ºä¾‹
    â”œâ”€â”€ simple_attention.py
    â”œâ”€â”€ simple_embedding.py
    â””â”€â”€ integrated_model.py
```

---

## æ–‡ä»¶æ”¾ç½®è¯¦ç»†æ­¥éª¤

### ç¬¬3æ­¥: é€æ­¥æ‹·è´æ–‡ä»¶

åˆ›å»ºè‡ªåŠ¨åŒ–è„šæœ¬ `copy_source_files.sh`:

```bash
#!/bin/bash
# ä»åŸé¡¹ç›®æ‹·è´æºæ–‡ä»¶åˆ°æ–°é¡¹ç›®

set -e

# é…ç½®è·¯å¾„
SOURCE_ROOT="/path/to/recsys-examples-main"  # ä¿®æ”¹ä¸ºä½ çš„æºè·¯å¾„
TARGET_ROOT="./accelerated_modules"          # æ–°é¡¹ç›®è·¯å¾„

echo "======================================"
echo "æºç çº§è¿ç§»è„šæœ¬"
echo "æºè·¯å¾„: $SOURCE_ROOT"
echo "ç›®æ ‡è·¯å¾„: $TARGET_ROOT"
echo "======================================"

# ============================================
# ç¬¬1æ­¥: åˆ›å»ºç›®å½•ç»“æ„
# ============================================
echo ""
echo "[1/6] åˆ›å»ºç›®å½•ç»“æ„..."

mkdir -p $TARGET_ROOT
mkdir -p $TARGET_ROOT/hstu_attn/csrc/src
mkdir -p $TARGET_ROOT/hstu_attn/csrc/src/generated
mkdir -p $TARGET_ROOT/dynamicemb/src/hkv_variable_instantiations
mkdir -p $TARGET_ROOT/dynamicemb/python/planner
mkdir -p $TARGET_ROOT/dynamicemb/python/shard
mkdir -p $TARGET_ROOT/third_party
mkdir -p $TARGET_ROOT/tests
mkdir -p $TARGET_ROOT/examples

echo "  âœ“ ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"

# ============================================
# ç¬¬2æ­¥: æ‹·è´HSTU Attentionæºç 
# ============================================
echo ""
echo "[2/6] æ‹·è´HSTU Attentionæºç ..."

# C++/CUDAæºç 
cp $SOURCE_ROOT/corelib/hstu/csrc/hstu_attn/hstu_api.cpp \
   $TARGET_ROOT/hstu_attn/csrc/

cp $SOURCE_ROOT/corelib/hstu/csrc/hstu_attn/src/*.h \
   $TARGET_ROOT/hstu_attn/csrc/src/

# Pythonæ¥å£
cp $SOURCE_ROOT/corelib/hstu/hstu_attn/__init__.py \
   $TARGET_ROOT/hstu_attn/

cp $SOURCE_ROOT/corelib/hstu/hstu_attn/hstu_attn_interface.py \
   $TARGET_ROOT/hstu_attn/interface.py

# ç¼–è¯‘é…ç½®
cp $SOURCE_ROOT/corelib/hstu/setup.py \
   $TARGET_ROOT/hstu_attn/

echo "  âœ“ HSTU Attentionæºç æ‹·è´å®Œæˆ"

# ============================================
# ç¬¬3æ­¥: æ‹·è´Dynamic Embeddingsæºç 
# ============================================
echo ""
echo "[3/6] æ‹·è´Dynamic Embeddingsæºç ..."

# CUDAæºç  (é€ä¸ªæ‹·è´ï¼Œå› ä¸ºæ–‡ä»¶å¾ˆå¤š)
for file in dynamic_emb_op.cu dynamic_variable_base.cu dynamic_variable_base.h \
            hkv_variable.h hkv_variable.cuh \
            lookup_forward.cu lookup_forward.h lookup_backward.cu lookup_backward.h \
            lookup_kernel.cuh optimizer.cu optimizer.h optimizer_kernel.cuh \
            initializer.cu initializer.cuh unique_op.cu unique_op.h \
            unique_variable.cu unique_variable.h \
            index_calculation.cu index_calculation.h \
            sparse_block_bucketize_features.cu sparse_block_bucketize_features_utils.h \
            torch_utils.cu torch_utils.h utils.cpp utils.h check.h module_bind.cu; do
    if [ -f "$SOURCE_ROOT/corelib/dynamicemb/src/$file" ]; then
        cp "$SOURCE_ROOT/corelib/dynamicemb/src/$file" \
           "$TARGET_ROOT/dynamicemb/src/"
    fi
done

# HKVå®ä¾‹åŒ–æ–‡ä»¶
cp $SOURCE_ROOT/corelib/dynamicemb/src/hkv_variable_instantiations/*.cu \
   $TARGET_ROOT/dynamicemb/src/hkv_variable_instantiations/

# Pythonæ¥å£
cp -r $SOURCE_ROOT/corelib/dynamicemb/dynamicemb/* \
      $TARGET_ROOT/dynamicemb/python/

# ç¼–è¯‘é…ç½®
cp $SOURCE_ROOT/corelib/dynamicemb/setup.py \
   $TARGET_ROOT/dynamicemb/

cp $SOURCE_ROOT/corelib/dynamicemb/version.txt \
   $TARGET_ROOT/dynamicemb/

echo "  âœ“ Dynamic Embeddingsæºç æ‹·è´å®Œæˆ"

# ============================================
# ç¬¬4æ­¥: åˆå§‹åŒ–Gitå­æ¨¡å—
# ============================================
echo ""
echo "[4/6] åˆå§‹åŒ–ç¬¬ä¸‰æ–¹ä¾èµ–..."

cd $TARGET_ROOT

# åˆå§‹åŒ–Git (å¦‚æœè¿˜æ²¡æœ‰)
if [ ! -d ".git" ]; then
    git init
fi

# æ·»åŠ CUTLASSå­æ¨¡å—
if [ ! -d "third_party/cutlass/.git" ]; then
    git submodule add https://github.com/NVIDIA/cutlass.git third_party/cutlass
    cd third_party/cutlass
    git checkout v3.5.0  # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬
    cd ../..
fi

# æ·»åŠ HierarchicalKVå­æ¨¡å—
if [ ! -d "third_party/HierarchicalKV/.git" ]; then
    git submodule add https://github.com/NVIDIA-Merlin/HierarchicalKV.git third_party/HierarchicalKV
    cd third_party/HierarchicalKV
    git checkout main
    cd ../..
fi

# æ›´æ–°å­æ¨¡å—
git submodule update --init --recursive

cd -

echo "  âœ“ ç¬¬ä¸‰æ–¹ä¾èµ–åˆå§‹åŒ–å®Œæˆ"

# ============================================
# ç¬¬5æ­¥: åˆ›å»ºé…ç½®æ–‡ä»¶
# ============================================
echo ""
echo "[5/6] åˆ›å»ºé…ç½®æ–‡ä»¶..."

# requirements.txt
cat > $TARGET_ROOT/requirements.txt << 'EOF'
torch>=2.0.0
einops
packaging
ninja
setuptools>=69.5.1
scikit-build
torchrec>=1.2.0
EOF

# ä¸»setup.py
cat > $TARGET_ROOT/setup.py << 'EOF'
"""
HSTU + Dynamic Embeddings åŠ é€Ÿæ¨¡å—
"""
from setuptools import setup, find_packages

setup(
    name='accelerated_modules',
    version='1.0.0',
    description='HSTU Attention + Dynamic Embeddings for A100 GPU',
    packages=find_packages(),
    python_requires='>=3.9',
    install_requires=[
        'torch>=2.0.0',
        'einops',
        'packaging',
        'ninja',
    ],
)
EOF

# README.md
cat > $TARGET_ROOT/README.md << 'EOF'
# Accelerated Modules for A100 GPU

HSTU Attention (CUTLASS) + Dynamic Embeddings (HierarchicalKV)

## ç¼–è¯‘

```bash
bash build.sh
```

## ä½¿ç”¨

```python
from hstu_attn import hstu_attn_varlen_func
from dynamicemb import DynamicEmbeddingBagCollection
```

## è¦æ±‚

- NVIDIA A100 GPU (SM 8.0)
- CUDA >= 11.6
- Python >= 3.9
- PyTorch >= 2.0.0
EOF

# ç¼–è¯‘è„šæœ¬
cat > $TARGET_ROOT/build.sh << 'BASHEOF'
#!/bin/bash
# ç¼–è¯‘HSTUå’ŒDynamic Embeddings

set -e

echo "======================================"
echo "ç¼–è¯‘åŠ é€Ÿæ¨¡å—"
echo "======================================"

# æ£€æŸ¥ç¯å¢ƒ
echo ""
echo "[1/4] æ£€æŸ¥ç¼–è¯‘ç¯å¢ƒ..."
command -v nvcc >/dev/null 2>&1 || { echo "é”™è¯¯: nvccæœªæ‰¾åˆ°"; exit 1; }
command -v python >/dev/null 2>&1 || { echo "é”™è¯¯: pythonæœªæ‰¾åˆ°"; exit 1; }
echo "  âœ“ NVCC: $(nvcc --version | grep release)"
echo "  âœ“ Python: $(python --version)"

# æ›´æ–°å­æ¨¡å—
echo ""
echo "[2/4] æ›´æ–°Gitå­æ¨¡å—..."
git submodule update --init --recursive
echo "  âœ“ å­æ¨¡å—å·²æ›´æ–°"

# ç¼–è¯‘HSTU Attention
echo ""
echo "[3/4] ç¼–è¯‘HSTU Attention (çº¦30-60åˆ†é’Ÿ)..."
cd hstu_attn
export HSTU_DISABLE_86OR89=TRUE
export HSTU_DISABLE_ARBITRARY=TRUE
export HSTU_DISABLE_LOCAL=TRUE
export HSTU_DISABLE_RAB=TRUE
export HSTU_DISABLE_DRAB=TRUE
export TORCH_CUDA_ARCH_LIST="8.0"
export MAX_JOBS=4
export NVCC_THREADS=4
pip install . --no-deps
cd ..
echo "  âœ“ HSTU Attentionç¼–è¯‘å®Œæˆ"

# ç¼–è¯‘Dynamic Embeddings
echo ""
echo "[4/4] ç¼–è¯‘Dynamic Embeddings (çº¦10-20åˆ†é’Ÿ)..."
cd dynamicemb
export TORCH_CUDA_ARCH_LIST="8.0"
export MAX_JOBS=4
pip install . --no-deps
cd ..
echo "  âœ“ Dynamic Embeddingsç¼–è¯‘å®Œæˆ"

echo ""
echo "======================================"
echo "âœ“ ç¼–è¯‘å®Œæˆï¼"
echo "======================================"
echo ""
echo "éªŒè¯å®‰è£…:"
echo "  python -c 'import hstu_attn; import dynamicemb'"
echo ""
BASHEOF

chmod +x $TARGET_ROOT/build.sh

echo "  âœ“ é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"

# ============================================
# ç¬¬6æ­¥: åˆ›å»ºæµ‹è¯•å’Œç¤ºä¾‹
# ============================================
echo ""
echo "[6/6] åˆ›å»ºæµ‹è¯•å’Œç¤ºä¾‹..."

# ç®€å•æµ‹è¯•
cat > $TARGET_ROOT/tests/test_hstu_attention.py << 'PYEOF'
"""æµ‹è¯•HSTU Attention"""
import torch
from hstu_attn import hstu_attn_varlen_func

def test_hstu_attention():
    print("æµ‹è¯•HSTU Attention...")
    
    # åˆ›å»ºæµ‹è¯•æ•°æ®
    q = torch.randn(200, 4, 64, dtype=torch.bfloat16).cuda()
    k = torch.randn(200, 4, 64, dtype=torch.bfloat16).cuda()
    v = torch.randn(200, 4, 64, dtype=torch.bfloat16).cuda()
    cu_seqlens = torch.tensor([0, 100, 200], dtype=torch.int32).cuda()
    
    # å‰å‘ä¼ æ’­
    output = hstu_attn_varlen_func(
        q, k, v, cu_seqlens, cu_seqlens, 100, 100
    )
    
    assert output.shape == q.shape
    print(f"âœ“ è¾“å‡ºshape: {output.shape}")
    print("âœ“ æµ‹è¯•é€šè¿‡")

if __name__ == "__main__":
    test_hstu_attention()
PYEOF

cat > $TARGET_ROOT/tests/test_dynamicemb.py << 'PYEOF'
"""æµ‹è¯•Dynamic Embeddings"""
import torch
from torchrec import EmbeddingBagConfig
from dynamicemb import DynamicEmbeddingBagCollection

def test_dynamicemb():
    print("æµ‹è¯•Dynamic Embeddings...")
    
    # åˆ›å»ºembeddingé…ç½®
    ebc = DynamicEmbeddingBagCollection(
        tables=[
            EmbeddingBagConfig(
                name="test_emb",
                embedding_dim=128,
                num_embeddings=1000000,
                feature_names=["feature_id"],
            ),
        ],
        device=torch.device("cuda:0"),
    )
    
    print("âœ“ Dynamic Embeddingsåˆ›å»ºæˆåŠŸ")
    print("âœ“ æµ‹è¯•é€šè¿‡")

if __name__ == "__main__":
    test_dynamicemb()
PYEOF

# ä½¿ç”¨ç¤ºä¾‹
cat > $TARGET_ROOT/examples/simple_attention.py << 'PYEOF'
"""ç®€å•çš„HSTU Attentionä½¿ç”¨ç¤ºä¾‹"""
import torch
from hstu_attn import hstu_attn_varlen_func

# åˆ›å»ºæµ‹è¯•æ•°æ®
batch_size = 2
num_heads = 4
head_dim = 64
seqlen = 100

q = torch.randn(batch_size * seqlen, num_heads, head_dim, 
                dtype=torch.bfloat16).cuda()
k = torch.randn(batch_size * seqlen, num_heads, head_dim, 
                dtype=torch.bfloat16).cuda()
v = torch.randn(batch_size * seqlen, num_heads, head_dim, 
                dtype=torch.bfloat16).cuda()
cu_seqlens = torch.tensor([0, seqlen, 2*seqlen], dtype=torch.int32).cuda()

# HSTU Attention
output = hstu_attn_varlen_func(
    q, k, v, cu_seqlens, cu_seqlens, seqlen, seqlen, causal=True
)

print(f"è¾“å…¥shape: {q.shape}")
print(f"è¾“å‡ºshape: {output.shape}")
print("âœ“ HSTU Attentionå·¥ä½œæ­£å¸¸")
PYEOF

echo "  âœ“ æµ‹è¯•å’Œç¤ºä¾‹åˆ›å»ºå®Œæˆ"

# ============================================
# å®Œæˆ
# ============================================
echo ""
echo "======================================"
echo "âœ“ æºç è¿ç§»å®Œæˆï¼"
echo "======================================"
echo ""
echo "ç›®å½•ç»“æ„:"
tree -L 2 $TARGET_ROOT 2>/dev/null || ls -R $TARGET_ROOT
echo ""
echo "ä¸‹ä¸€æ­¥:"
echo "  1. cd $TARGET_ROOT"
echo "  2. bash build.sh           # ç¼–è¯‘æ¨¡å—"
echo "  3. python tests/test_hstu_attention.py   # æµ‹è¯•"
echo ""
```

ä½¿ç”¨è¿™ä¸ªè„šæœ¬ï¼š

```bash
# 1. ä¿®æ”¹SOURCE_ROOTä¸ºä½ çš„æºè·¯å¾„
vim copy_source_files.sh

# 2. è¿è¡Œè„šæœ¬
bash copy_source_files.sh

# 3. è¿›å…¥æ–°é¡¹ç›®
cd accelerated_modules

# 4. æŸ¥çœ‹ç»“æ„
tree -L 2
```

---

## ç¼–è¯‘é…ç½®

### ç¬¬4æ­¥: ä¿®æ”¹ç¼–è¯‘é…ç½®

#### A. ä¿®æ”¹HSTU Attentionçš„setup.py

ç¼–è¾‘ `accelerated_modules/hstu_attn/setup.py`:

```python
# å…³é”®ä¿®æ”¹ç‚¹:

# 1. ä¿®æ”¹CUTLASSè·¯å¾„
cutlass_dir = Path("../third_party/cutlass")  # æŒ‡å‘æ–°ä½ç½®

# 2. åªç¼–è¯‘A100
cc_flag = []
cc_flag.append("-gencode")
cc_flag.append("arch=compute_80,code=sm_80")  # åªè¦è¿™ä¸€è¡Œ

# 3. ç¦ç”¨ä¸éœ€è¦çš„åŠŸèƒ½
export HSTU_DISABLE_86OR89=TRUE       # ç¦ç”¨SM 8.9
export HSTU_DISABLE_ARBITRARY=TRUE    # ç¦ç”¨ä»»æ„mask
export HSTU_DISABLE_LOCAL=TRUE        # ç¦ç”¨å±€éƒ¨mask
export HSTU_DISABLE_RAB=TRUE          # ç¦ç”¨ç›¸å¯¹ä½ç½®åç½®
export HSTU_DISABLE_DRAB=TRUE         # ç¦ç”¨åŠ¨æ€ç›¸å¯¹ä½ç½®åç½®
```

#### B. ä¿®æ”¹Dynamic Embeddingsçš„setup.py

ç¼–è¾‘ `accelerated_modules/dynamicemb/setup.py`:

```python
# å…³é”®ä¿®æ”¹ç‚¹:

# 1. ä¿®æ”¹HierarchicalKVè·¯å¾„
hkv_dir = Path("../third_party/HierarchicalKV")

# 2. åªç¼–è¯‘A100
extra_compile_args = {
    "nvcc": [
        "-O3",
        "-gencode", "arch=compute_80,code=sm_80",  # åªç¼–è¯‘SM 8.0
        # åˆ é™¤å…¶ä»–æ¶æ„
    ],
}

# 3. ä¿®æ”¹æºæ–‡ä»¶è·¯å¾„
cuda_sources = find_source_files(
    os.path.join(root_path, "src"),  # æŒ‡å‘æ–°çš„srcç›®å½•
    r".*\.cu$|.*\.cpp$",
)
```

---

## ä½¿ç”¨æ–¹æ³•

### ç¬¬5æ­¥: ç¼–è¯‘å’Œä½¿ç”¨

```bash
# ============================================
# 5.1 ç¼–è¯‘æ¨¡å—
# ============================================
cd accelerated_modules

# ä¸€é”®ç¼–è¯‘
bash build.sh

# æˆ–åˆ†æ­¥ç¼–è¯‘
# æ­¥éª¤1: æ›´æ–°å­æ¨¡å—
git submodule update --init --recursive

# æ­¥éª¤2: ç¼–è¯‘HSTU
cd hstu_attn
export TORCH_CUDA_ARCH_LIST="8.0"
export HSTU_DISABLE_86OR89=TRUE
export HSTU_DISABLE_ARBITRARY=TRUE
export HSTU_DISABLE_LOCAL=TRUE
export HSTU_DISABLE_RAB=TRUE
export HSTU_DISABLE_DRAB=TRUE
pip install . --no-deps
cd ..

# æ­¥éª¤3: ç¼–è¯‘DynamicEmb
cd dynamicemb
export TORCH_CUDA_ARCH_LIST="8.0"
pip install . --no-deps
cd ..

# ============================================
# 5.2 éªŒè¯å®‰è£…
# ============================================
python -c "
from hstu_attn import hstu_attn_varlen_func
from dynamicemb import DynamicEmbeddingBagCollection
print('âœ“ å¯¼å…¥æˆåŠŸ')
"

# ============================================
# 5.3 è¿è¡Œæµ‹è¯•
# ============================================
python tests/test_hstu_attention.py
python tests/test_dynamicemb.py

# ============================================
# 5.4 è¿è¡Œç¤ºä¾‹
# ============================================
python examples/simple_attention.py
```

---

## ç¯å¢ƒé…ç½®

### ç¬¬6æ­¥: å®Œæ•´ç¯å¢ƒé…ç½®

#### A. åˆ›å»ºcondaç¯å¢ƒ

```bash
# åˆ›å»ºç¯å¢ƒ
conda create -n accel_modules python=3.10 -y
conda activate accel_modules

# å®‰è£…PyTorch (CUDA 12.1)
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```

#### B. å®‰è£…ä¾èµ–

```bash
cd accelerated_modules

# å®‰è£…Pythonä¾èµ–
pip install -r requirements.txt

# å®‰è£…ç¼–è¯‘å·¥å…·
pip install ninja setuptools==69.5.1 scikit-build

# å®‰è£…TorchRec (DynamicEmbéœ€è¦)
pip install --no-deps tensordict orjson
git clone -b v1.2.0 https://github.com/pytorch/torchrec.git /tmp/torchrec
cd /tmp/torchrec
pip install --no-deps .
cd -
```

#### C. é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `accelerated_modules/env.sh`:

```bash
#!/bin/bash
# ç¯å¢ƒå˜é‡é…ç½®

# CUDAè·¯å¾„
export CUDA_HOME=/usr/local/cuda-12.1
export PATH=$CUDA_HOME/bin:$PATH
export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

# ç¼–è¯‘é€‰é¡¹
export TORCH_CUDA_ARCH_LIST="8.0"          # åªç¼–è¯‘A100
export MAX_JOBS=4                          # å¹¶è¡Œç¼–è¯‘æ•°
export NVCC_THREADS=4                      # NVCCçº¿ç¨‹æ•°

# HSTUç¼–è¯‘é€‰é¡¹
export HSTU_DISABLE_86OR89=TRUE
export HSTU_DISABLE_ARBITRARY=TRUE
export HSTU_DISABLE_LOCAL=TRUE
export HSTU_DISABLE_RAB=TRUE
export HSTU_DISABLE_DRAB=TRUE

echo "âœ“ ç¯å¢ƒå˜é‡å·²è®¾ç½®"
```

ä½¿ç”¨ï¼š
```bash
source env.sh
bash build.sh
```

---

## å®Œæ•´å·¥ä½œæµç¨‹æ€»ç»“

### ä»é›¶å¼€å§‹çš„å®Œæ•´æ­¥éª¤

```bash
# ========================================
# æ­¥éª¤1: å‡†å¤‡æºç  (åœ¨åŸé¡¹ç›®æœºå™¨ä¸Š)
# ========================================
cd /path/to/recsys-examples-main

# ç¡®ä¿å­æ¨¡å—å·²åˆå§‹åŒ–
git submodule update --init --recursive

# ========================================
# æ­¥éª¤2: è¿è¡Œè¿ç§»è„šæœ¬ (å¯ä»¥åœ¨ä»»æ„æœºå™¨)
# ========================================
# ä¸‹è½½è¿ç§»è„šæœ¬
wget https://your-server/copy_source_files.sh

# ä¿®æ”¹è·¯å¾„
vim copy_source_files.sh
# ä¿®æ”¹: SOURCE_ROOT="/path/to/recsys-examples-main"

# è¿è¡Œè„šæœ¬
bash copy_source_files.sh

# ========================================
# æ­¥éª¤3: é…ç½®æ–°é¡¹ç›®ç¯å¢ƒ
# ========================================
cd accelerated_modules

# åˆ›å»ºcondaç¯å¢ƒ
conda create -n accel_modules python=3.10 -y
conda activate accel_modules

# å®‰è£…PyTorch
pip install torch --index-url https://download.pytorch.org/whl/cu121

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å®‰è£…TorchRec
pip install torchrec==1.2.0

# ========================================
# æ­¥éª¤4: ç¼–è¯‘æ¨¡å—
# ========================================
# é…ç½®ç¯å¢ƒå˜é‡
source env.sh

# ä¸€é”®ç¼–è¯‘ (çº¦40-80åˆ†é’Ÿ)
bash build.sh

# ========================================
# æ­¥éª¤5: æµ‹è¯•éªŒè¯
# ========================================
# åŸºæœ¬å¯¼å…¥æµ‹è¯•
python -c "from hstu_attn import hstu_attn_varlen_func; print('OK')"
python -c "from dynamicemb import DynamicEmbeddingBagCollection; print('OK')"

# è¿è¡Œæµ‹è¯•
python tests/test_hstu_attention.py
python tests/test_dynamicemb.py

# è¿è¡Œç¤ºä¾‹
python examples/simple_attention.py

# ========================================
# æ­¥éª¤6: åœ¨ä½ çš„é¡¹ç›®ä¸­ä½¿ç”¨
# ========================================
# æ–¹å¼1: ç›´æ¥ä½¿ç”¨ (åœ¨åŒä¸€ç¯å¢ƒ)
python your_model.py

# æ–¹å¼2: æ‰“åŒ…åˆ†å‘
cd hstu_attn && python setup.py bdist_wheel
cd ../dynamicemb && python setup.py bdist_wheel
# å°†ç”Ÿæˆçš„.whlæ–‡ä»¶åˆ†å‘åˆ°å…¶ä»–æœºå™¨

# æ–¹å¼3: ä½œä¸ºå­æ¨¡å—
cd /your/other/project
git submodule add /path/to/accelerated_modules
```

---

## æ–‡ä»¶å¤§å°å’Œæ—¶é—´ä¼°ç®—

### ç£ç›˜ç©ºé—´éœ€æ±‚

```
æºç æ–‡ä»¶:              ~100 MB
third_party/cutlass:   ~500 MB (åªéœ€å¤´æ–‡ä»¶)
third_party/HKV:       ~50 MB
ç¼–è¯‘äº§ç‰©:              2-5 GB
æ€»è®¡:                  ~3-6 GB
```

### ç¼–è¯‘æ—¶é—´ (A100æœåŠ¡å™¨)

```
HSTU Attention:       30-60 åˆ†é’Ÿ
Dynamic Embeddings:   10-20 åˆ†é’Ÿ
æ€»è®¡:                 40-80 åˆ†é’Ÿ
```

### å†…å­˜éœ€æ±‚

```
ç¼–è¯‘HSTU:             32-64 GB RAM
ç¼–è¯‘DynamicEmb:       16-32 GB RAM
è¿è¡Œæ—¶:               40 GB GPU + 8 GB RAM
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. æ‰¾ä¸åˆ°CUTLASSå¤´æ–‡ä»¶

```bash
# æ£€æŸ¥å­æ¨¡å—
cd accelerated_modules
git submodule status

# é‡æ–°åˆå§‹åŒ–
git submodule update --init --recursive third_party/cutlass

# éªŒè¯
ls third_party/cutlass/include/cutlass/cutlass.h
```

#### 2. ç¼–è¯‘æ—¶å†…å­˜ä¸è¶³

```bash
# å‡å°‘å¹¶è¡Œæ•°
export MAX_JOBS=2
export NVCC_THREADS=2

# é‡æ–°ç¼–è¯‘
cd hstu_attn
pip install . --force-reinstall --no-cache-dir
```

#### 3. Pythonæ‰¾ä¸åˆ°ç¼–è¯‘çš„åº“

```python
# æ£€æŸ¥å®‰è£…ä½ç½®
pip show hstu_attn
pip show dynamicemb

# æ‰‹åŠ¨æ·»åŠ è·¯å¾„
import sys
sys.path.insert(0, '/path/to/accelerated_modules')
```

#### 4. CUDAç‰ˆæœ¬ä¸åŒ¹é…

```bash
# æ£€æŸ¥
nvcc --version
python -c "import torch; print(torch.version.cuda)"

# é‡æ–°å®‰è£…åŒ¹é…çš„PyTorch
pip install torch --index-url https://download.pytorch.org/whl/cu121
```

---

## ä¼˜åŠ¿å’Œé€‚ç”¨åœºæ™¯

### æºç çº§è¿ç§»çš„ä¼˜åŠ¿

âœ… **å®Œå…¨æ§åˆ¶**: å¯ä»¥ä¿®æ”¹ä»»ä½•ä»£ç 
âœ… **ä¾¿äºè°ƒè¯•**: æœ‰å®Œæ•´æºç 
âœ… **çµæ´»å®šåˆ¶**: å¯ä»¥æ·»åŠ æ–°åŠŸèƒ½
âœ… **ç‰ˆæœ¬ç‹¬ç«‹**: ä¸ä¾èµ–åŸé¡¹ç›®æ›´æ–°
âœ… **å­¦ä¹ å‹å¥½**: å¯ä»¥æ·±å…¥ç†è§£å®ç°

### é€‚ç”¨åœºæ™¯

- éœ€è¦ä¿®æ”¹CUDAå†…æ ¸
- éœ€è¦æ·»åŠ æ–°åŠŸèƒ½
- éœ€è¦æ·±åº¦å®šåˆ¶
- ä½œä¸ºç‹¬ç«‹é¡¹ç›®ç»´æŠ¤
- å­¦ä¹ å’Œç ”ç©¶ç›®çš„

---

## æ€»ç»“

è¿™ä¸ªæ–¹æ¡ˆæä¾›äº†**æœ€å®Œæ•´çš„æºç çº§è¿ç§»**ï¼š

1. âœ… **è¯¦ç»†çš„æ–‡ä»¶æ¸…å•** - çŸ¥é“æ‹¿å“ªäº›æ–‡ä»¶
2. âœ… **æ¸…æ™°çš„ç›®å½•ç»“æ„** - çŸ¥é“æ€ä¹ˆç»„ç»‡
3. âœ… **è‡ªåŠ¨åŒ–è„šæœ¬** - ä¸€é”®å®Œæˆæ‹·è´
4. âœ… **ç¼–è¯‘é…ç½®** - å¼€ç®±å³ç”¨
5. âœ… **å®Œæ•´æµ‹è¯•** - éªŒè¯åŠŸèƒ½æ­£å¸¸
6. âœ… **ç¯å¢ƒé…ç½®** - ä»é›¶é…ç½®ç¯å¢ƒ

**æ€»æ—¶é—´**: çº¦2-3å°æ—¶ (åŒ…æ‹¬ç¼–è¯‘)

éœ€è¦æˆ‘æä¾›æ›´è¯¦ç»†çš„æŸä¸ªæ­¥éª¤å—ï¼ŸğŸš€

